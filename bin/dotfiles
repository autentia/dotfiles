#!/usr/bin/env bash

set -e

# http://stackoverflow.com/questions/1055671/how-can-i-get-the-behavior-of-gnus-readlink-f-on-a-mac
function readlink_f() {
    local target_file="${1}"
    local file_name

    while [ "${target_file}" != "" ]; do
        cd "$(dirname ${target_file})"
        file_name="$(basename "${target_file}")"
        target_file="$(readlink "${file_name}")"
    done

    echo "$(pwd -P)/${file_name}"
}

# =====================================
# MAIN
# =====================================

DEFAULT_DOTFILES_ROOT="$(cd "$(dirname "$(readlink_f "${0}")")/.." && pwd)"
export DOTFILES_ROOT=${DOTFILES_ROOT:-DEFAULT_DOTFILES_ROOT}
export DOTFILES_DEBUG=${DOTFILES_DEBUG:-"false"}
export DOTFILES_OS_UPDATE_OS=${DOTFILES_OS_UPDATE_OS:-"true"}

add_dotfiles_internal_libraries_to_path $DOTFILES_ROOT

command="${1:-}"
case "${command}" in
    "" )
        dotfiles-version $DOTFILES_ROOT $DOTFILES_DEBUG
        dotfiles-help
        ;;
    -v | --version )
        dotfiles-version
        ;;
    -h | --help )
        dotfiles-help
        ;;
    * )
        command_path="$(command -v "dotfiles-${command}" || true)"
        if [ -z "${command_path}" ];then
            {
                echo "No such command '${command}'"
                exec dotfiles-version
                exec dotfiles-help
            }
        fi
        # Move the arrays to start at position 1 instead of 0 for $@ by default
        shift 1
        "${command_path}" "$DOTFILES_ROOT" $DOTFILES_DEBUG  "$@"
        ;;
esac
